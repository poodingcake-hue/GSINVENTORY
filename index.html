<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css");

        :root {
            --color-accent: #6c757d;
            --color-accent-dark: #495057;
            --color-background: #fff;
            --color-surface: #fff;
            --color-text-primary: #333;
            --color-text-secondary: #666;
            --color-shadow: rgba(0, 0, 0, 0.08);
            --font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            --color-border-light: #e0e0e0;
            --color-danger: #dc3545;
            --color-danger-dark: #c82333;
            --font-size-base: 14px;
            --font-size-sm: 13px;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .column {
            padding: 20px;
            border-right: 1px solid var(--color-border-light);
            overflow-y: auto;
            background-color: var(--color-surface);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .column:nth-child(1) {
            flex: 0 0 25%;
            max-width: 25%;
            min-width: 280px;
            background-color: #fdfdfd;
        }

        .column:nth-child(2) {
            flex: 0 0 45%;
            max-width: 45%;
            min-width: 500px;
            padding: 25px;
        }

        .column:nth-child(3) {
            flex: 0 0 30%;
            max-width: 30%;
            min-width: 300px;
            border-right: none;
            background-color: #fafafa;
        }

        /* íƒ€ì´í¬ê·¸ë˜í”¼ */
        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 20px 0 10px 0;
        }

        h4 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .section-header-with-line {
            border-bottom: 1px solid var(--color-border-light);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        hr {
            border: 0;
            height: 1px;
            background: var(--color-border-light);
            margin: 15px 0;
        }

        /* ë¡œë” ë° ìœ í‹¸ë¦¬í‹° */
        .loader {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 0.9em;
        }

        .hidden {
            display: none !important;
        }

        /* 1ì—´: ë¸Œëœë“œ ê·¸ë¦¬ë“œ */
        .brand-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 20px;
        }

        .brand-item {
            padding: 8px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-color: #fff;
            text-align: center;
            font-weight: 600;
            font-size: 12.5px;
            /* 6ê¸€ì ìˆ˜ìš©ì„ ìœ„í•´ ì¡°ì • */
            color: #555;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .brand-item:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .brand-item.selected {
            background-color: var(--color-accent-dark);
            color: #fff;
            border-color: var(--color-accent-dark);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* 1ì—´: ìƒí’ˆ ëª©ë¡ */
        .product-item {
            padding: 10px 12px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 6px;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item:hover {
            border-color: #bbb;
            background-color: #f8f9fa;
        }

        .product-item.selected {
            background-color: var(--color-accent);
            color: #fff;
            border-color: var(--color-accent);
        }

        .product-item.selected .product-code {
            color: #f1f3f5;
        }

        .product-name {
            font-weight: 500;
            font-size: 0.95em;
        }

        .product-code {
            font-size: 0.8em;
            color: #999;
        }

        /* 2ì—´: ìƒí’ˆ ìƒì„¸ */
        .info-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .info-location {
            position: absolute;
            left: 0;
            top: 0;
            font-weight: 700;
            color: var(--color-accent);
            font-size: 1.1em;
            cursor: pointer;
            border-bottom: 1px dashed transparent;
            transition: all 0.2s;
        }

        .info-location:hover {
            border-bottom-color: var(--color-accent);
            opacity: 0.8;
        }

        .info-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: #333;
            line-height: 1.3;
            margin-top: 5px;
            display: inline-block;
        }

        #product-image-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            background: #fcfcfc;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        #product-image {
            max-width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            display: block;
            transition: opacity 0.3s ease-in-out;
            will-change: opacity;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ì¬ê³  í…Œì´ë¸” - ê°€ë…ì„± ê°œì„  */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.95em;
            table-layout: fixed;
        }

        .inventory-table th,
        .inventory-table td {
            border: 1px solid #e0e0e0;
            padding: 10px 5px;
            text-align: center;
        }

        .inventory-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
        }

        .inventory-table td {
            color: #333;
        }

        .inventory-cell {
            cursor: pointer;
            background-color: #fff;
            font-weight: 700;
            color: #333;
            transition: background-color 0.15s;
        }

        .inventory-cell:hover {
            background-color: #f1f3f5;
            color: var(--color-accent-dark);
        }

        /* ë…¸íŠ¸ ë° í•˜ë‹¨ ê·¸ë¦¬ë“œ */
        .note-container {
            margin-bottom: 20px;
        }

        .note-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
            background: #fafafa;
            box-sizing: border-box;
        }

        .note-input:focus {
            background: #fff;
            border-color: var(--color-accent);
            outline: none;
        }

        .bottom-grids {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .grid-section {
            flex: 1;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            background: #fff;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .outfit-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .outfit-item {
            border: 1px solid #eee;
            background-color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .outfit-item:hover {
            border-color: #ccc;
        }

        .outfit-host {
            font-weight: bold;
            margin-right: 8px;
            padding-right: 8px;
            border-right: 1px solid #eee;
            min-width: 40px;
            text-align: center;
        }

        .outfit-size {
            color: var(--color-accent);
        }

        /* 3ì—´: ëŒ€ì—¬/ë°˜ë‚© íƒ­ ë° ì•¡ì…˜ */
        .toggle-buttons {
            display: flex;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            overflow: hidden;
        }

        .toggle-buttons button {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: #555;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0;
        }

        .toggle-buttons button:first-child {
            border-right: none;
        }

        .toggle-buttons button.active {
            background: var(--color-accent-dark);
            color: #fff;
            border-color: var(--color-accent-dark);
        }

        /* ì¥ë°”êµ¬ë‹ˆ ë° ê²€ìƒ‰ ê²°ê³¼ */
        .control-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .select-all-btn {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            background: #fff;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            cursor: pointer;
        }

        .select-all-btn:hover {
            background: #f1f3f5;
        }

        .checkout-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--color-accent-dark);
            color: white;
            border: none;
            border-radius: 6px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background 0.2s;
        }

        .checkout-btn:hover {
            background-color: #343a40;
        }

        .col-chk {
            flex: 0 0 35px;
            border-right: 1px solid #eee;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .col-renter {
            flex: 0 0 70px;
            font-weight: 600;
            color: #333;
            border-right: 1px solid #eee;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .col-main {
            flex: 1;
            text-align: left;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .col-main .prod-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 2px;
            white-space: normal;
            line-height: 1.2;
            word-break: keep-all;
        }

        .col-main .prod-sub {
            font-size: 0.82em;
            color: #777;
            margin-top: 2px;
        }

        .col-qty {
            flex: 0 0 45px;
            color: var(--color-danger);
            font-weight: 700;
            border-left: 1px solid #eee;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .col-date {
            flex: 0 0 85px;
            color: #888;
            font-size: 0.78em;
            border-left: 1px solid #eee;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .return-list-header {
            display: flex;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
            font-weight: 700;
            font-size: 0.85em;
            color: #495057;
            text-align: center;
            height: 40px;
            align-items: center;
        }

        .return-item {
            display: flex;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            height: 54px;
            align-items: center;
            transition: background 0.1s;
            background: #fff;
        }

        .return-item:hover {
            background-color: #f1f3f5;
        }

        /* Modals & Toasts */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: var(--color-accent);
            color: #fff;
        }

        .modal-btn.ghost {
            background: #fff;
            border-color: #ccc;
            color: #333;
            margin-right: 8px;
        }

        .toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
        }

        .toast-message {
            background: rgba(33, 37, 41, 0.9);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            margin-top: 10px;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeInOut 2.5s forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            15% {
                opacity: 1;
                transform: translateY(0);
            }

            85% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .modal-overlay.hidden {
            display: none !important;
        }

        #receipt-modal.modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            z-index: 5000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .receipt-modal-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .receipt-container {
            background: #fff;
            width: 480px;
            padding: 60px 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            font-family: var(--font-family);
            color: #1a1a1a;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 4px;
        }

        .scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .receipt-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .receipt-icon-btn {
            background: #f5f5f5;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            color: #1a1a1a;
        }

        .receipt-icon-btn.close-btn {
            position: absolute;
            top: -20px;
            right: -60px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            width: 44px;
            height: 44px;
            font-size: 24px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            z-index: 7000;
            backdrop-filter: blur(10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .receipt-icon-btn.close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fff;
            transform: scale(1.1) rotate(90deg);
        }

        /* Zig-Zag Edge Restoration & Refinement */
        .receipt-container::before,
        .receipt-container::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            height: 12px;
            background-size: 24px 24px;
            background-repeat: repeat-x;
            z-index: 10;
        }

        .receipt-container::before {
            top: -12px;
            background-image: linear-gradient(-45deg, transparent 12px, #fff 12px),
                linear-gradient(45deg, transparent 12px, #fff 12px);
        }

        .receipt-container::after {
            bottom: -12px;
            background-image: linear-gradient(-45deg, #fff 12px, transparent 12px),
                linear-gradient(45deg, #fff 12px, transparent 12px);
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #eee;
            padding-bottom: 30px;
            margin-bottom: 30px;
        }

        .receipt-logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 2px;
            color: #000;
            margin-bottom: 8px;
        }

        .receipt-title {
            font-size: 14px;
            color: #666;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .receipt-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 8px;
            color: #444;
        }

        .receipt-info-row .label {
            color: #888;
            font-weight: 500;
        }

        .receipt-divider {
            border-top: 2px dashed #eee;
            margin: 25px 0;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .receipt-table th {
            text-align: left;
            padding: 12px 0;
            border-bottom: 1px solid #000;
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
        }

        .receipt-table td {
            padding: 15px 0;
            vertical-align: top;
            border-bottom: 1px solid #f5f5f5;
        }

        .product-group-header {
            font-weight: 800;
            font-size: 15px;
            color: #000;
            padding-top: 20px !important;
            border-bottom: none !important;
        }

        .variant-row td {
            padding: 6px 0 6px 15px !important;
            color: #666;
            font-size: 13px;
        }

        .qty-cell {
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 700;
            font-size: 16px;
        }

        .receipt-total-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            font-weight: 800;
            font-size: 18px;
            border-top: 1px solid #000;
            margin-top: 10px;
        }

        .receipt-signature-section {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .sig-box {
            text-align: center;
            font-size: 12px;
            color: #888;
        }

        .sig-line {
            border-bottom: 1px solid #ccc;
            height: 40px;
            margin-bottom: 10px;
        }

        .receipt-footer-note {
            text-align: center;
            font-size: 11px;
            color: #aaa;
            line-height: 1.5;
            margin-top: 40px;
        }

        .receipt-close-btn {
            display: none;
            /* Hide the old fixed button */
        }

        .receipt-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body>*:not(#receipt-modal) {
                display: none !important;
            }

            #receipt-modal.modal-overlay {
                display: flex !important;
                background: #fff !important;
                visibility: visible !important;
                position: static !important;
                height: 100vh;
                align-items: center;
                justify-content: center;
            }

            .modal-overlay {
                background: #fff !important;
                backdrop-filter: none !important;
            }

            .receipt-container {
                box-shadow: none !important;
                border: 1px solid #eee;
                margin: 0 auto;
                width: 480px;
            }

            .receipt-close-btn,
            .receipt-controls {
                display: none !important;
            }
        }

        .suggestions-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .suggestions-box.visible {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            align-items: center;
            transition: background 0.1s;
            font-size: 0.9em;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f1f3f5;
        }

        .suggestion-text {
            font-weight: 500;
            color: #333;
        }

        /* ìƒí’ˆ ê²€ìƒ‰ ì¸í’‹ ìŠ¤íƒ€ì¼ */
        .header-with-search {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 10px 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .header-with-search h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .product-search-container {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .product-search-input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
            width: 100px;
        }

        .small-search-btn {
            padding: 6px 10px;
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* ë°˜ì¶œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .rental-history-item {
            padding: 12px 0;
            font-size: 0.9em;
        }

        /* 3ì—´ ë°˜ë‚© ê²€ìƒ‰ ë ˆì´ì•„ì›ƒ ê°œí¸ */
        .return-search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            background: #fff;
            padding: 5px 0;
        }

        .return-search-input-group {
            flex: 1;
            display: flex;
            gap: 5px;
            min-width: 0;
        }

        .unified-search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-width: 0;
        }

        .select-all-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9em;
            font-weight: 700;
            color: #333;
            padding-left: 5px;
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-accent-dark);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* 3ì—´ ê³ ì • í—¤ë” ì˜ì—­ */
        .sticky-header {
            position: sticky;
            top: -20px;
            /* columnì˜ padding 20px ìƒì‡„ */
            background: var(--color-surface);
            z-index: 100;
            margin: -20px -20px 20px -20px;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid var(--color-border-light);
        }

        /* ì¥ë°”êµ¬ë‹ˆ ìŠ¤íƒ€ì¼ */
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fff;
            transition: transform 0.1s;
        }

        .cart-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .cart-info-wrapper {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .cart-text-details {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .cart-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
        }

        .quantity-input {
            width: 45px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }

        .delete-btn {
            cursor: pointer;
            color: #999;
            font-weight: 800;
            padding: 5px;
            transition: color 0.2s;
            font-size: 1.1em;
        }

        .delete-btn:hover {
            color: var(--color-danger);
        }

        .btn-loading {
            opacity: 0.6 !important;
            pointer-events: none !important;
            cursor: wait !important;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="col1" class="column">
            <h2>ë¸Œëœë“œ ë° ìƒí’ˆ ì„ íƒ</h2>
            <div id="brand-list" class="brand-grid">
                <div class="loader">ë¸Œëœë“œ ëª©ë¡ ë¡œë”© ì¤‘...</div>
            </div>
            <hr>
            <div class="header-with-search">
                <h3><span id="selected-brand-name">ë¸Œëœë“œ ì„ íƒ</span></h3>
                <div id="product-search-container" class="product-search-container" style="display:none;">
                    <input type="text" id="product-search-input" class="product-search-input" placeholder="ê²€ìƒ‰">
                    <button id="product-search-btn" class="small-search-btn">ì¡°íšŒ</button>
                </div>
            </div>
            <div id="product-list">
                <div class="loader">ë¸Œëœë“œë¥¼ ì„ íƒí•˜ë©´ ìƒí’ˆ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>

        <div id="col2" class="column">
            <div id="product-details-content" class="hidden">
                <div id="product-image-container">
                    <img id="product-image" src="" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                </div>
                <div class="info-header">
                    <span id="product-location" class="info-location" title="í´ë¦­í•˜ì—¬ ìœ„ì¹˜ ìˆ˜ì •"></span>
                    <span id="product-name" class="info-name"></span>
                </div>
                <div id="inventory-matrix-container"></div>
                <div class="bottom-grids">
                    <div id="outfit-section" class="grid-section">
                        <div class="grid-header">
                            <h4>ì°©ì¥ ë‚´ì—­ ì¡°íšŒ ë° ì…ë ¥</h4>
                            <button id="add-outfit-btn" class="edit-btn">â• ì…ë ¥</button>
                        </div>
                        <div id="outfit-list"></div>
                    </div>
                    <div id="rental-history-section" class="grid-section">
                        <div class="grid-header">
                            <h4>ë°˜ì¶œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ (ëŒ€ì—¬ì¤‘)</h4>
                        </div>
                        <div id="rental-history-list"></div>
                    </div>
                </div>
            </div>
            <div id="col2-placeholder">
                <div class="loader">ìƒí’ˆì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì¬ê³  ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>

        <div id="col3" class="column">
            <div class="sticky-header">
                <h2>ëŒ€ì—¬ ë° ë°˜ë‚©</h2>
                <div class="toggle-buttons">
                    <button id="toggle-rental" class="active">ëŒ€ì—¬</button>
                    <button id="toggle-return">ë°˜ë‚©</button>
                </div>
            </div>

            <div id="rental-checkout" class="rental-checkout">
                <h3 class="section-header-with-line">ëŒ€ì—¬ ì¥ë°”êµ¬ë‹ˆ</h3>
                <div class="control-buttons" style="margin-bottom: 15px;">
                    <label class="select-all-wrapper">
                        <input type="checkbox" id="select-all-rental-chk" class="select-all-checkbox" checked>
                        ì „ì²´ ì„ íƒ
                    </label>
                </div>
                <div id="cart-list">
                    <div class="loader">ì¬ê³ í‘œì—ì„œ ì¬ê³  ìˆ˜ëŸ‰ì„ í´ë¦­í•˜ì—¬ ìƒí’ˆì„ ë‹´ìœ¼ì„¸ìš”.</div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="renter-name">ëŒ€ì—¬ì ì´ë¦„:</label>
                    <input type="text" id="renter-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                        style="width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px;">
                </div>
                <button id="process-rental-btn" class="checkout-btn">ì¼ê´„ ëŒ€ì—¬ ì™„ë£Œ</button>
            </div>

            <div id="return-checkout" class="return-checkout hidden">
                <h3 class="section-header-with-line">ë°˜ë‚© ë‚´ì—­ ì¡°íšŒ</h3>
                <div class="return-search-bar">
                    <div class="return-search-input-group">
                        <div class="search-input-wrapper">
                            <input type="text" id="unified-search-input" class="unified-search-input"
                                placeholder="ë¸Œëœë“œ/ëŒ€ì—¬ì ê²€ìƒ‰">
                            <div id="search-suggestions" class="suggestions-box"></div>
                        </div>
                        <button id="search-execute-btn" class="search-execute-btn">ì¡°íšŒ</button>
                    </div>
                    <label class="select-all-wrapper">
                        <input type="checkbox" id="select-all-return-chk" class="select-all-checkbox">
                        ì „ì²´ ì„ íƒ <span id="return-list-count"></span>
                    </label>
                </div>
                <div id="return-list-container">
                    <div class="return-list-header">
                        <div class="col-chk">ì„ íƒ</div>
                        <div class="col-renter">ëŒ€ì—¬ì</div>
                        <div class="col-main">ìƒí’ˆ ì •ë³´</div>
                        <div class="col-qty">ìˆ˜ëŸ‰</div>
                        <div class="col-date">ëŒ€ì—¬ì¼</div>
                    </div>
                    <div id="return-list">
                        <div class="loader">ë¸Œëœë“œ ë˜ëŠ” ëŒ€ì—¬ì ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="returner-name">ë°˜ë‚© ì²˜ë¦¬ì ì´ë¦„:</label>
                    <input type="text" id="returner-name" placeholder="ì²˜ë¦¬ì ì´ë¦„"
                        style="width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px;">
                </div>
                <button id="process-return-btn" class="checkout-btn">ì„ íƒ ìƒí’ˆ ì¼ê´„ ë°˜ë‚©</button>
            </div>
        </div>
    </div>

    <div id="outfit-input-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h4>ì°©ì¥ ë‚´ì—­ ì…ë ¥ (<span id="modal-product-name">ìƒí’ˆëª…</span>)</h4>
            </div>
            <div class="modal-body">
                <table class="outfit-input-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ì°©ì¥ì ì´ë¦„</th>
                            <th>ì‚¬ì´ì¦ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="host-name" data-row="1" placeholder="ì´ë¦„ (í•„ìˆ˜)"></td>
                            <td><input type="text" class="outfit-size" data-row="1" placeholder="ì‚¬ì´ì¦ˆ (í•„ìˆ˜)"></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><input type="text" class="host-name" data-row="2" placeholder="ì´ë¦„"></td>
                            <td><input type="text" class="outfit-size" data-row="2" placeholder="ì‚¬ì´ì¦ˆ"></td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td><input type="text" class="host-name" data-row="3" placeholder="ì´ë¦„"></td>
                            <td><input type="text" class="outfit-size" data-row="4" placeholder="ì‚¬ì´ì¦ˆ"></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><input type="text" class="host-name" data-row="4" placeholder="ì´ë¦„"></td>
                            <td><input type="text" class="outfit-size" data-row="4" placeholder="ì‚¬ì´ì¦ˆ"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="cancel-outfit-btn" class="modal-btn ghost">ì·¨ì†Œ</button>
                <button id="confirm-outfit-btn" class="modal-btn primary">í™•ì¸ ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- í˜„ëŒ€ì  ì „ì ì˜ìˆ˜ì¦ (í•˜ì´ë¸Œë¦¬ë“œ ë””ìì¸) -->
    <div id="receipt-modal" class="modal-overlay hidden">
        <div class="receipt-modal-wrapper scale-in">
            <button class="receipt-icon-btn close-btn" onclick="closeReceiptModal()" title="ë‹«ê¸° (ESC)">âœ•</button>
            <div class="receipt-container">
                <div class="receipt-controls">
                    <button class="receipt-icon-btn" onclick="window.print()" title="ì¸ì‡„">ğŸ–¨ï¸</button>
                </div>
                <div class="receipt-header">
                    <div class="receipt-logo">GS SHOP</div>
                    <div class="receipt-title">ë°©ì†¡ì¤€ë¹„ì‹¤ ë°˜ì¶œí™•ì¸ì„œ</div>
                </div>

                <div class="receipt-info-row">
                    <span class="label">ëŒ€ì—¬ì¼ì‹œ</span>
                    <span id="receipt-date">2024-00-00 00:00:00</span>
                </div>
                <div class="receipt-info-row">
                    <span class="label">ëŒ€ì—¬ì</span>
                    <span id="receipt-renter">í™ê¸¸ë™</span>
                </div>

                <div class="receipt-divider"></div>

                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th style="width: 70%;">Items</th>
                            <th style="width: 30%; text-align: right;">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items-body">
                        <!-- Items will be injected here -->
                    </tbody>
                </table>

                <div class="receipt-total-section">
                    <span>TOTAL ITEMS</span>
                    <span id="receipt-total-qty">0</span>
                </div>

                <div class="receipt-signature-section">
                    <div class="sig-box">
                        <div class="sig-line"></div>
                        <div>ëŒ€ì—¬ì ì„œëª…</div>
                    </div>
                    <div class="sig-box">
                        <div class="sig-line"></div>
                        <div>ê´€ë¦¬ì í™•ì¸</div>
                    </div>
                </div>

                <div class="receipt-footer-note">
                    ë³¸ í™•ì¸ì„œëŠ” GS SHOP ë°©ì†¡ì¤€ë¹„ì‹¤ì—ì„œì˜ ìƒ˜í”Œë°˜ì¶œì„ ì¦ëª…í•©ë‹ˆë‹¤.<br>

                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        let appData = null;
        let currentBrand = null;
        let currentProductCode = null;
        let rentalCart = [];
        let currentReturnItems = [];
        const imageMemoryCache = {}; // ì„¸ì…˜ ì´ë¯¸ì§€ ìºì‹œ
        let searchTimeout = null;     // ê²€ìƒ‰ ë””ë°”ìš´ì‹±ìš©

        // ìœ ì˜ì–´ ì‚¬ì „
        const SYNONYMS = {
            'ì•„ìš°í„°': ['ìì¼“', 'ì í¼', 'ì½”íŠ¸', 'íŒ¨ë”©', 'ê°€ë””ê±´', 'ì¬í‚·', 'ë² ìŠ¤íŠ¸', 'ë‹¤ìš´'],
            'ìƒì˜': ['í‹°ì…”ì¸ ', 'ì…”ì¸ ', 'ë¸”ë¼ìš°ìŠ¤', 'ë‹ˆíŠ¸', 'ë§¨íˆ¬ë§¨', 'í‹°', 'íƒ‘', 'top'],
            'í•˜ì˜': ['ë°”ì§€', 'íŒ¬ì¸ ', 'ìŠ¤ì»¤íŠ¸', 'ì¹˜ë§ˆ', 'ìŠ¬ë™ìŠ¤', 'ì§„', 'ë°ë‹˜'],
            'ì¡í™”': ['ë¨¸í”ŒëŸ¬', 'ë°±'],
            'ì•…ì„¸ì‚¬ë¦¬': ['ëª¨ì', 'ê°€ë°©', 'ë²¨íŠ¸', 'ì–‘ë§', 'ìŠ¤ì¹´í”„', 'ëª©ë„ë¦¬']
        };

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // [ìˆ˜ì •] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ì „ ë°ì´í„° ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê³ ì† ì´ˆê¸° ë Œë”ë§)
            const cachedData = localStorage.getItem('inventory_app_data');
            if (cachedData) {
                try {
                    appData = JSON.parse(cachedData);
                    if (appData && appData.brands) {
                        renderBrandList();
                        console.log('ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¦‰ì‹œ ë Œë”ë§í•¨');
                    }
                } catch (e) {
                    localStorage.removeItem('inventory_app_data');
                }
            }

            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            if (!appData) showLoader('brand-list', 'ë°ì´í„° ë™ê¸°í™” ì¤‘...');

            callBackend('loadAllData')
                .then(function (data) {
                    // ë°ì´í„°ê°€ ë¹„ì—ˆê±°ë‚˜ ì—ëŸ¬ì¸ ê²½ìš° ì²´í¬
                    if (!data || !data.brands) {
                        console.warn('ë°›ì•„ì˜¨ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }

                    appData = data;
                    if (!appData.notes) appData.notes = {};

                    // ìµœì‹  ë°ì´í„°ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                    localStorage.setItem('inventory_app_data', JSON.stringify(data));

                    // í˜„ì¬ ë¸Œëœë“œ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ ë Œë”ë§ ê²°ì • (ì‚¬ìš©ì ë°©í•´ ìµœì†Œí™”)
                    renderBrandList();
                    if (currentBrand) {
                        renderProductList(currentBrand);
                    }

                    console.log('ë°±ì—”ë“œ ì •ë°€ ë™ê¸°í™” ì™„ë£Œ');
                })
                .catch(function (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    // ìºì‹œì¡°ì°¨ ì—†ëŠ” ê²½ìš°ì—ë§Œ ê²½ê³ 
                    if (!appData) alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                });
        }

        // GAS Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbwUhg-Wra36tHNgQ9Ql8BPSMj8LfEF8n-cww7WpoNtujVI3hWb0un9iWx3JhLvMaEM5/exec";

        function callBackend(funcName) {
            console.log('Back-end Request:', funcName);
            var args = Array.prototype.slice.call(arguments, 1);
            return fetch(API_URL, {
                method: 'POST',
                mode: 'cors',
                redirect: 'follow', // Required for GAS
                headers: {
                    'Content-Type': 'text/plain' // Avoids CORS preflight (OPTIONS)
                },
                body: JSON.stringify({ "function": funcName, "arguments": args })
            })
                .then(function (response) {
                    if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
                    return response.json();
                })
                .then(function (result) {
                    console.log('Back-end Response:', result);
                    if (result && result.success === false) throw new Error(result.message || 'ì‹¤íŒ¨');
                    return result;
                })
                .catch(function (err) {
                    console.error('API Call Failed:', err);
                    throw err;
                });
        }

        function showLoader(elementId, message) {
            var element = document.getElementById(elementId);
            if (element) element.innerHTML = '<div class="loader">' + (message || 'ë¡œë”© ì¤‘...') + '</div>';
        }

        function setupEventListeners() {
            if (document.getElementById('toggle-rental')) document.getElementById('toggle-rental').onclick = function () { toggleCheckoutMode('rental'); };
            if (document.getElementById('toggle-return')) document.getElementById('toggle-return').onclick = function () { toggleCheckoutMode('return'); };

            if (document.getElementById('add-outfit-btn')) document.getElementById('add-outfit-btn').onclick = showOutfitInputModal;
            if (document.getElementById('cancel-outfit-btn')) document.getElementById('cancel-outfit-btn').onclick = closeOutfitInputModal;
            if (document.getElementById('confirm-outfit-btn')) document.getElementById('confirm-outfit-btn').onclick = processOutfitInput;

            if (document.getElementById('process-rental-btn')) document.getElementById('process-rental-btn').onclick = processRentalCheckout;
            if (document.getElementById('select-all-rental-chk')) {
                document.getElementById('select-all-rental-chk').onclick = function (e) {
                    toggleAllCartItems(e.target.checked);
                };
            }

            if (document.getElementById('process-return-btn')) document.getElementById('process-return-btn').onclick = processReturnCheckout;
            if (document.getElementById('select-all-return-chk')) {
                document.getElementById('select-all-return-chk').onclick = function (e) {
                    toggleAllReturnItems(e.target.checked);
                };
            }


            var searchInput = document.getElementById('unified-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInputSuggestions);
                searchInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') executeSearch(); });
            }
            if (document.getElementById('search-execute-btn')) document.getElementById('search-execute-btn').onclick = executeSearch;

            document.addEventListener('click', function (e) {
                var suggestionsBox = document.getElementById('search-suggestions');
                if (suggestionsBox && e.target !== searchInput && e.target !== suggestionsBox) {
                    suggestionsBox.classList.remove('visible');
                }
            });

            // ìƒí’ˆ ê²€ìƒ‰ ë¦¬ìŠ¤ë„ˆ (ë””ë°”ìš´ì‹± ì ìš©: 200ms)
            var prodSearch = document.getElementById('product-search-input');
            var prodSearchBtn = document.getElementById('product-search-btn');
            if (prodSearch) {
                prodSearch.addEventListener('input', function (e) {
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function () {
                        renderProductList(null, e.target.value);
                    }, 200);
                });
                prodSearch.addEventListener('keydown', function (e) { if (e.key === 'Enter') renderProductList(null, prodSearch.value); });
            }
            if (prodSearchBtn) prodSearchBtn.onclick = function () { renderProductList(null, prodSearch.value); };
        }

        function renderBrandList() {
            var div = document.getElementById('brand-list');
            div.innerHTML = '';
            if (!appData || !appData.brands || !appData.brands.length) { div.innerHTML = '<div class="loader">ë°ì´í„° ì—†ìŒ</div>'; return; }
            var fragment = document.createDocumentFragment();
            appData.brands.forEach(function (brand) {
                var item = document.createElement('div');
                item.className = 'brand-item';
                item.textContent = brand;
                item.onclick = function () { selectBrand(brand, item); };
                fragment.appendChild(item);
            });
            div.appendChild(fragment);
        }

        function selectBrand(brandName, element) {
            var items = document.querySelectorAll('.brand-item');
            for (var i = 0; i < items.length; i++) { items[i].classList.remove('selected'); }
            element.classList.add('selected');

            currentBrand = brandName;
            document.getElementById('selected-brand-name').textContent = brandName;

            var searchContainer = document.getElementById('product-search-container');
            if (searchContainer) searchContainer.style.display = 'flex';
            var searchInput = document.getElementById('product-search-input');
            if (searchInput) searchInput.value = ''; // ë¸Œëœë“œ ë³€ê²½ ì‹œ ê²€ìƒ‰ ì´ˆê¸°í™”

            renderProductList(brandName);
        }

        function renderProductList(brandName, filterKeyword) {
            var targetBrand = brandName || currentBrand;

            var searchContainer = document.getElementById('product-search-container');
            if (targetBrand) {
                if (searchContainer) searchContainer.style.display = 'flex';
                document.getElementById('selected-brand-name').textContent = targetBrand;
            } else if (filterKeyword) {
                if (searchContainer) searchContainer.style.display = 'flex';
                document.getElementById('selected-brand-name').textContent = 'ê²€ìƒ‰ ê²°ê³¼';
            }
            if (!targetBrand) return;

            var div = document.getElementById('product-list');
            div.innerHTML = '';
            if (!appData || !appData.rawData) { div.innerHTML = '<div class="loader">ë°ì´í„° ì—†ìŒ</div>'; return; }

            // 1. ë¸Œëœë“œë¡œ 1ì°¨ í•„í„°ë§
            var brandProducts = appData.rawData.filter(function (item) { return item.productName.indexOf(targetBrand) !== -1; });

            // 2. ê²€ìƒ‰ì–´ë¡œ 2ì°¨ í•„í„°ë§ (ìœ ì˜ì–´ í¬í•¨)
            if (filterKeyword) {
                var keyword = filterKeyword.trim().toLowerCase();
                if (keyword) {
                    brandProducts = brandProducts.filter(function (item) {
                        var name = item.productName.toLowerCase();
                        var code = String(item.productCode).toLowerCase();

                        // ê¸°ë³¸ í¬í•¨ ì—¬ë¶€
                        if (name.includes(keyword) || code.includes(keyword)) return true;

                        // ìœ ì˜ì–´ ì²´í¬
                        // ì…ë ¥ëœ í‚¤ì›Œë“œê°€ ìœ ì˜ì–´ í‚¤(Key)ì¸ ê²½ìš° -> ê°’(Value)ë“¤ ì¤‘ í•˜ë‚˜ë¼ë„ ì´ë¦„ì— í¬í•¨ë˜ë©´ OK
                        if (SYNONYMS[keyword]) {
                            return SYNONYMS[keyword].some(function (syn) { return name.includes(syn); });
                        }
                        // ì…ë ¥ëœ í‚¤ì›Œë“œê°€ ìœ ì˜ì–´ ê°’(Value) ì¤‘ í•˜ë‚˜ì¸ ê²½ìš° -> í‚¤(Key)ê°€ ì´ë¦„ì— í¬í•¨ë˜ì–´ë„ OK (ì—­ë°©í–¥ì€ ì„ íƒì‚¬í•­, ì—¬ê¸°ì„  ìƒëµí•˜ê³  í™•ì¥ ê²€ìƒ‰ë§Œ)
                        // í˜¹ì€ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì•„ì„œ ê·¸ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ìœ ì˜ì–´ë¥¼ ê²€ìƒ‰
                        for (var key in SYNONYMS) {
                            if (SYNONYMS[key].includes(keyword) || key === keyword) {
                                if (name.includes(key)) return true;
                                if (SYNONYMS[key].some(function (syn) { return name.includes(syn); })) return true;
                            }
                        }
                        return false;
                    });
                }
            }

            var uniqueProducts = {};
            brandProducts.forEach(function (item) {
                if (!uniqueProducts[item.productCode]) {
                    uniqueProducts[item.productCode] = { code: item.productCode, name: item.productName };
                }
            });

            var products = Object.keys(uniqueProducts).map(function (key) { return uniqueProducts[key]; });
            products.sort(function (a, b) {
                var codeA = parseInt(a.code.replace(/[^0-9]/g, '') || '0');
                var codeB = parseInt(b.code.replace(/[^0-9]/g, '') || '0');
                return codeB - codeA;
            });

            if (!products.length) { div.innerHTML = '<div class="loader">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>'; return; }

            var fragment = document.createDocumentFragment();
            products.forEach(function (product) {
                var item = document.createElement('div');
                item.className = 'product-item';
                if (currentProductCode === product.code) item.classList.add('selected');

                var nameSpan = document.createElement('span');
                nameSpan.className = 'product-name';
                nameSpan.textContent = product.name;

                var codeSpan = document.createElement('span');
                codeSpan.className = 'product-code';
                codeSpan.textContent = product.code;

                item.appendChild(nameSpan);
                item.appendChild(codeSpan);
                item.onclick = function () { selectProduct(product.code, item, product.name); };
                fragment.appendChild(item);
            });
            div.appendChild(fragment);
        }

        function selectProduct(productCode, element, productName) {
            if (currentProductCode === productCode) return;
            currentProductCode = productCode;
            var items = document.querySelectorAll('.product-item');
            for (var i = 0; i < items.length; i++) { items[i].classList.remove('selected'); }
            element.classList.add('selected');
            renderProductDetails(productCode, productName);
        }

        function editProductLocation() {
            if (!currentProductCode) return;
            var currentLocation = document.getElementById('product-location').textContent.trim();
            var newLocation = prompt('ìƒˆë¡œìš´ ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', currentLocation);

            if (newLocation !== null && newLocation !== currentLocation) {
                showToast('ìœ„ì¹˜ ì €ì¥ ì¤‘...');
                callBackend('saveProductLocation', currentProductCode, newLocation)
                    .then(function (result) {
                        if (result.success) {
                            showToast('ìœ„ì¹˜ ìˆ˜ì • ì™„ë£Œ', true);
                            document.getElementById('product-location').textContent = ' ' + newLocation;

                            // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                            if (appData && appData.rawData) {
                                appData.rawData.forEach(function (item) {
                                    if (item.productCode === currentProductCode) item.location = newLocation;
                                });
                                localStorage.setItem('inventory_app_data', JSON.stringify(appData));
                            }
                        } else {
                            showToast('ì €ì¥ ì‹¤íŒ¨');
                        }
                    })
                    .catch(function (err) {
                        showToast('ì˜¤ë¥˜ ë°œìƒ');
                        console.error(err);
                    });
            }
        }

        function generateGsShopUrl(productCode) {
            // ì½”ë“œê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ ìƒì„± ë¶ˆê°€
            if (!productCode || productCode.length < 6) return null;

            // ë¬¸ìì—´ íŒŒì‹± (ì—‘ì…€ ìˆ˜ì‹: LEFT(2), MID(3,2), MID(5,2) êµ¬í˜„)
            var p1 = productCode.substring(0, 2);
            var p2 = productCode.substring(2, 4);
            var p3 = productCode.substring(4, 6);

            // URL ì¡°í•©
            return 'https://image.gsshop.com/image/' + p1 + '/' + p2 + '/' + p3 + '/' + productCode + '_B1.jpg';
        }

        function renderProductDetails(productCode, productName) {
            document.getElementById('col2-placeholder').classList.add('hidden');
            document.getElementById('product-details-content').classList.remove('hidden');

            var inventoryData = appData.rawData.filter(function (item) { return item.productCode === productCode && item.quantity > 0; });

            // --- ìµœì í™”ëœ ì´ë¯¸ì§€ í‘œì‹œ ë¡œì§ (Fast-First + Memory Cache) ---
            var singleImg = document.getElementById('product-image');
            var sheetImageUrl = appData.images[productCode];
            var webImageUrl = generateGsShopUrl(productCode);

            console.log("Rendering Image (Optimized) for Product:", productCode);

            // 1. ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸ (ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œí•˜ê³  ì¢…ë£Œ)
            if (imageMemoryCache[productCode]) {
                console.log("Memory Cache Hit!");
                singleImg.src = imageMemoryCache[productCode];
                // ë¶ˆí•„ìš”í•œ ì—°ì‚° ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œ ë°˜í™˜ ì—°ê³„ ì²˜ë¦¬ ìƒëµ (ì•„ë˜ UI ì—…ë°ì´íŠ¸ëŠ” í•„ìš”)
            } else {
                // 2. ì¦‰ì‹œ ì›¹ ì´ë¯¸ì§€ í‘œì‹œ (ê°€ì¥ ë¹ ë¦„)
                singleImg.classList.remove('fade-in');
                singleImg.src = webImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                void singleImg.offsetWidth; // ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ì‚¬í•­ì„ ì¦‰ì‹œ ì¸ì‹í•˜ë„ë¡ í•¨
                singleImg.classList.add('fade-in');

                // 3. ë“œë¼ì´ë¸Œ ì£¼ì†Œê°€ ìˆëŠ” ê²½ìš° ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³ í™”ì§ˆ ë¡œë“œ
                if (sheetImageUrl && sheetImageUrl.indexOf('drive.google.com') !== -1) {
                    callBackend('getDriveImageBase64', sheetImageUrl)
                        .then(function (result) {
                            var imageData = "";
                            if (result && typeof result === 'object' && result.data) {
                                imageData = result.data;
                                if (result.mimeType && typeof imageData === 'string' && imageData.indexOf('data:') !== 0) {
                                    imageData = 'data:' + result.mimeType + ';base64,' + imageData;
                                }
                            } else {
                                imageData = result;
                            }

                            if (typeof imageData === 'string' && imageData.indexOf('data:') === 0) {
                                console.log("Drive Image loaded and cached.");
                                imageMemoryCache[productCode] = imageData; // ìºì‹œ ì €ì¥

                                // ë‹¤ë¥¸ ìƒí’ˆìœ¼ë¡œ ë„˜ì–´ê°”ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì½”ë“œ í™•ì¸ í›„ êµì²´
                                if (currentProductCode === productCode) {
                                    singleImg.style.opacity = '0.5';
                                    setTimeout(function () {
                                        singleImg.src = imageData;
                                        singleImg.style.opacity = '1';
                                    }, 50);
                                }
                            }
                        })
                        .catch(function (err) {
                            console.warn("Drive image load failed. Current image remains.", err);
                        });
                } else if (sheetImageUrl) {
                    // ë“œë¼ì´ë¸Œê°€ ì•„ë‹Œ ì§ì ‘ ë§í¬ì¸ ê²½ìš° ì¦‰ì‹œ êµì²´ ë° ìºì‹±
                    singleImg.src = sheetImageUrl;
                    imageMemoryCache[productCode] = sheetImageUrl;
                }
            }

            // ì´ë¯¸ì§€ ë¡œë“œ ì—ëŸ¬ ë°œìƒ ì‹œ ìµœì¢… Fallback
            singleImg.onerror = function () {
                var currentSrc = String(this.src);
                if (currentSrc !== webImageUrl && webImageUrl) {
                    this.src = webImageUrl;
                }
            };
            // ---------------------------

            var location = inventoryData[0] ? inventoryData[0].location : 'N/A';
            var displayName = (inventoryData[0] ? inventoryData[0].productName : productName);

            document.getElementById('product-location').textContent = ' ' + location;
            document.getElementById('product-location').onclick = editProductLocation;
            document.getElementById('product-name').textContent = displayName;

            if (inventoryData.length) {
                renderInventoryMatrix(inventoryData, displayName);
            } else {
                document.getElementById('inventory-matrix-container').innerHTML = '<div class="loader">ì¬ê³  ì—†ìŒ</div>';
            }

            renderOutfits(productCode);
            renderRentalHistory(productCode);
        }


        function renderInventoryMatrix(inventoryData, productName) {
            var container = document.getElementById('inventory-matrix-container');
            var colors = [];
            var sizes = [];

            inventoryData.forEach(function (item) {
                if (colors.indexOf(item.color) === -1) colors.push(item.color);
                if (sizes.indexOf(item.size) === -1) sizes.push(item.size);
            });
            colors.sort();
            sizes = sortSizes(sizes);

            if (!colors.length || !sizes.length) { container.innerHTML = '<div class="loader">ì •ë³´ ì—†ìŒ</div>'; return; }

            var html = '<table class="inventory-table"><thead><tr><th>ã€€</th>';
            sizes.forEach(function (size) { html += '<th>' + size + '</th>'; });
            html += '</tr></thead><tbody>';

            colors.forEach(function (color) {
                html += '<tr><th>' + color + '</th>';
                sizes.forEach(function (size) {
                    var totalQty = 0;
                    var skuCode = '';
                    inventoryData.forEach(function (item) {
                        if (item.color === color && item.size === size) {
                            totalQty += item.quantity;
                            skuCode = item.skuCode;
                        }
                    });

                    if (totalQty > 0) {
                        html += '<td class="inventory-cell" data-color="' + color + '" data-size="' + size + '" data-qty="' + totalQty + '" data-sku="' + skuCode + '" data-product-name="' + productName + '">' + totalQty + '</td>';
                    } else {
                        html += '<td></td>';
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;

            var cells = document.querySelectorAll('.inventory-cell');
            for (var i = 0; i < cells.length; i++) {
                cells[i].onclick = handleInventoryCellClick;
            }
        }

        function sortSizes(sizes) {
            var sizeOrder = ['44', '55', '66', '77', '88', 'M55', 'M66', 'XS', 'S', 'M', 'L', 'XL', '2XL', 'XXL'];
            return sizes.sort(function (a, b) {
                var indexA = sizeOrder.indexOf(String(a).toUpperCase());
                var indexB = sizeOrder.indexOf(String(b).toUpperCase());
                if (indexA === -1 && indexB === -1) return String(a).localeCompare(String(b));
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }

        function handleInventoryCellClick(event) {
            toggleCheckoutMode('rental');
            var cell = event.currentTarget;
            var location = document.getElementById('product-location').textContent.trim();
            addToCart(currentProductCode, cell.dataset.productName, cell.dataset.color, cell.dataset.size, parseInt(cell.dataset.qty), cell.dataset.sku, location);
        }

        function renderOutfits(productCode) {
            var div = document.getElementById('outfit-list');
            div.innerHTML = '';
            var outfits = appData.outfits.filter(function (item) { return item.productCode === productCode; });
            if (!outfits.length) { div.innerHTML = '<div class="loader">ë‚´ì—­ ì—†ìŒ</div>'; return; }

            var fragment = document.createDocumentFragment();
            for (var i = 0; i < outfits.length; i += 2) {
                var pairDiv = document.createElement('div');
                pairDiv.className = 'outfit-pair';
                for (var j = 0; j < 2; j++) {
                    if (i + j < outfits.length) {
                        var outfit = outfits[i + j];
                        var itemDiv = document.createElement('div');
                        itemDiv.className = 'outfit-item';
                        itemDiv.dataset.hostName = outfit.hostName;
                        itemDiv.dataset.size = outfit.size;
                        itemDiv.dataset.productCode = productCode;
                        itemDiv.innerHTML = '<span class="outfit-host">' + outfit.hostName + '</span><span class="outfit-size">' + outfit.size + '</span>';
                        itemDiv.onclick = handleOutfitEdit;
                        pairDiv.appendChild(itemDiv);
                    }
                }
                fragment.appendChild(pairDiv);
            }
            div.appendChild(fragment);
        }

        function handleOutfitEdit(event) {
            var item = event.currentTarget;
            var productCode = item.dataset.productCode;
            var hostName = item.dataset.hostName;
            var oldSize = item.dataset.size;
            var newSize = prompt('[' + hostName + '] ì°©ì¥ ì‚¬ì´ì¦ˆ ìˆ˜ì •:', oldSize);
            if (newSize && newSize !== oldSize && confirm('ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                callBackend('updateOutfitSize', productCode, hostName, oldSize, newSize)
                    .then(function (result) {
                        if (result.success) {
                            showToast('ìˆ˜ì • ì™„ë£Œ', true);
                            var outfit = appData.outfits.find(function (o) { return o.productCode === productCode && o.hostName === hostName && o.size === oldSize; });
                            if (outfit) outfit.size = newSize;
                            renderOutfits(productCode);
                        } else { showToast('ìˆ˜ì • ì‹¤íŒ¨'); }
                    });
            }
        }

        function renderRentalHistory(productCode) {
            var div = document.getElementById('rental-history-list');
            div.innerHTML = '';
            var history = appData.rentals.filter(function (item) { return item.productCode === productCode && item.status === 'ëŒ€ì—¬ì¤‘'; });
            if (!history.length) { div.innerHTML = '<div class="loader">ëŒ€ì—¬ì¤‘ ë‚´ì—­ ì—†ìŒ</div>'; return; }

            var fragment = document.createDocumentFragment();
            history.forEach(function (item) {
                var itemDiv = document.createElement('div');
                itemDiv.className = 'rental-history-item';
                itemDiv.innerHTML = '<div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">' + item.size + ' / ' + item.color + ' / ' + Math.abs(item.quantity) + 'EA</span><span style="color: #666;">' + item.renter + ' ' + (item.rentalDate.split(' ')[0] || '').substring(5) + '</span></div>';
                fragment.appendChild(itemDiv);
            });
            div.appendChild(fragment);
        }

        function showOutfitInputModal() {
            if (!currentProductCode) { showToast('ìƒí’ˆ ì„ íƒ í•„ìš”'); return; }
            document.getElementById('modal-product-name').textContent = document.getElementById('product-name').textContent;
            document.getElementById('outfit-input-modal').classList.remove('hidden');
            var inputs = document.querySelectorAll('.host-name, .outfit-size');
            for (var i = 0; i < inputs.length; i++) inputs[i].value = '';
            document.getElementById('confirm-outfit-btn').disabled = false;
            document.getElementById('confirm-outfit-btn').textContent = 'í™•ì¸ ë° ì €ì¥';
        }
        function closeOutfitInputModal() { document.getElementById('outfit-input-modal').classList.add('hidden'); }

        function processOutfitInput() {
            var productCode = currentProductCode;
            if (!productCode) return;
            var inputs = [];
            for (var i = 1; i <= 4; i++) {
                var hostName = document.querySelector('.host-name[data-row="' + i + '"]').value.trim();
                var size = document.querySelector('.outfit-size[data-row="' + i + '"]').value.trim();
                if (hostName && size) inputs.push({ productCode: productCode, hostName: hostName, size: size });
            }
            if (inputs.length === 0) { showToast('ë°ì´í„° ì—†ìŒ'); return; }
            document.getElementById('confirm-outfit-btn').textContent = 'ì €ì¥ ì¤‘...';
            document.getElementById('confirm-outfit-btn').disabled = true;

            callBackend('saveOutfitsBulk', inputs)
                .then(function (result) {
                    if (result.success) {
                        showToast(result.savedCount + 'ê±´ ì €ì¥', true);
                        if (result.newOutfits) appData.outfits.push(...result.newOutfits);
                        renderOutfits(productCode);
                        closeOutfitInputModal();
                    } else { showToast('ì €ì¥ ì‹¤íŒ¨'); }
                })
                .catch(function () { showToast('í†µì‹  ì˜¤ë¥˜'); })
                .finally(function () { document.getElementById('confirm-outfit-btn').disabled = false; });
        }

        function addToCart(productCode, productName, color, size, maxQty, skuCode, location) {
            var existing = rentalCart.find(function (item) { return item.productCode === productCode && item.color === color && item.size === size; });
            if (existing) {
                if (existing.quantity < maxQty) { existing.quantity++; showToast('ìˆ˜ëŸ‰: ' + existing.quantity); }
                else { showToast('ì¬ê³  ì´ˆê³¼'); }
            } else {
                rentalCart.push({ productCode: productCode, productName: productName, color: color, size: size, skuCode: skuCode, quantity: 1, maxQty: maxQty, checked: true, location: location });
                showToast('ì¶”ê°€ë¨');
            }
            renderCart();
        }

        function renderCart() {
            var div = document.getElementById('cart-list');
            div.innerHTML = '';
            if (!rentalCart.length) { div.innerHTML = '<div class="loader">ë¹„ì–´ ìˆìŒ</div>'; return; }

            var fragment = document.createDocumentFragment();
            rentalCart.forEach(function (item, index) {
                var cartItem = document.createElement('div');
                cartItem.className = 'cart-item';

                // 1. ì •ë³´ ì˜ì—­ (ì²´í¬ë°•ìŠ¤ + í…ìŠ¤íŠ¸)
                var infoWrapper = document.createElement('div');
                infoWrapper.className = 'cart-info-wrapper';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.checked;
                checkbox.style.marginRight = '12px';
                checkbox.onchange = function (e) {
                    item.checked = e.target.checked;
                    syncSelectAllRentalCheckbox();
                };

                var textDetails = document.createElement('div');
                textDetails.className = 'cart-text-details';

                var nameDiv = document.createElement('div');
                nameDiv.style.fontWeight = '700';
                nameDiv.style.color = '#333';
                nameDiv.textContent = item.productName;

                var subDiv = document.createElement('div');
                subDiv.style.fontSize = '0.82em';
                subDiv.style.color = '#777';
                subDiv.style.marginTop = '2px';
                subDiv.textContent = item.size + ' / ' + item.color + ' (ì¬ê³ : ' + item.maxQty + ')';

                textDetails.appendChild(nameDiv);
                textDetails.appendChild(subDiv);
                infoWrapper.appendChild(checkbox);
                infoWrapper.appendChild(textDetails);

                // 2. ì•¡ì…˜ ì˜ì—­ (ìˆ˜ëŸ‰ + ì‚­ì œ)
                var actionsDiv = document.createElement('div');
                actionsDiv.className = 'cart-actions';

                var qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.className = 'quantity-input';
                qtyInput.min = 1; qtyInput.max = item.maxQty; qtyInput.value = item.quantity;
                qtyInput.onchange = function (e) {
                    var newQty = parseInt(e.target.value);
                    if (isNaN(newQty) || newQty < 1) newQty = 1;
                    if (newQty > item.maxQty) newQty = item.maxQty;
                    item.quantity = newQty; e.target.value = newQty;
                };

                var deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'âœ•';
                deleteBtn.onclick = function () { rentalCart.splice(index, 1); renderCart(); };

                actionsDiv.appendChild(qtyInput);
                actionsDiv.appendChild(deleteBtn);

                cartItem.appendChild(infoWrapper);
                cartItem.appendChild(actionsDiv);
                fragment.appendChild(cartItem);
            });
            div.appendChild(fragment);
        }
        function toggleAllCartItems(checked) {
            rentalCart.forEach(function (item) { item.checked = checked; });
            renderCart();
        }

        function syncSelectAllRentalCheckbox() {
            var allChecked = rentalCart.length > 0 && rentalCart.every(function (item) { return item.checked; });
            var selectAllChk = document.getElementById('select-all-rental-chk');
            if (selectAllChk) selectAllChk.checked = allChecked;
        }

        function processRentalCheckout() {
            var renterName = document.getElementById('renter-name').value.trim();
            if (!renterName) { showToast('ì´ë¦„ ì…ë ¥ í•„ìš”'); return; }
            var checkedItems = rentalCart.filter(function (item) { return item.checked && item.quantity > 0; });
            if (!checkedItems.length) { showToast('ìƒí’ˆ ì„ íƒ í•„ìš”'); return; }
            if (!confirm(renterName + 'ë‹˜ ëŒ€ì—¬ ì§„í–‰?')) return;

            var btn = document.getElementById('process-rental-btn');
            var originalText = btn.textContent;
            btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            btn.classList.add('btn-loading');

            callBackend('processRental', checkedItems, renterName)
                .then(function (result) {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-loading');
                    if (result.success) {
                        showToast(result.message || 'ëŒ€ì—¬ ì™„ë£Œ', true);
                        if (result.newRentals) result.newRentals.forEach(function (r) { appData.rentals.push(r); });

                        // --- ì‹¤ì‹œê°„ ì¬ê³  ì°¨ê° ë™ê¸°í™” ---
                        checkedItems.forEach(function (item) {
                            var rawItem = appData.rawData.find(function (r) {
                                return r.productCode === item.productCode && r.color === item.color && r.size === item.size;
                            });
                            if (rawItem) {
                                rawItem.quantity -= item.quantity;
                            }
                        });
                        // ìˆ˜ëŸ‰ì´ 0 ì´í•˜ê°€ ëœ ê²ƒì€ í•„í„°ë§ (ì„ íƒì‚¬í•­, UI ì¼ê´€ì„±ì„ ìœ„í•´)
                        appData.rawData = appData.rawData.filter(function (r) { return r.quantity > 0; });

                        // ì˜ìˆ˜ì¦ í‘œì‹œ ì „ì— ë°ì´í„° ì¤€ë¹„
                        var receiptItems = checkedItems.map(function (item) {
                            return {
                                name: item.productName,
                                details: item.color + ' / ' + item.size,
                                quantity: item.quantity,
                                location: item.location
                            };
                        });
                        var now = new Date();
                        var dateStr = now.getFullYear() + '-' +
                            String(now.getMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getDate()).padStart(2, '0') + ' ' +
                            String(now.getHours()).padStart(2, '0') + ':' +
                            String(now.getMinutes()).padStart(2, '0') + ':' +
                            String(now.getSeconds()).padStart(2, '0');

                        rentalCart = rentalCart.filter(function (item) { return !item.checked; });
                        renderCart();
                        document.getElementById('renter-name').value = '';

                        // í˜„ì¬ ë³´ê³  ìˆëŠ” ìƒí’ˆì˜ ì¬ê³ í‘œ ì¦‰ì‹œ ê°±ì‹ 
                        if (currentProductCode) renderProductDetails(currentProductCode, document.getElementById('product-name').textContent);

                        // ì „ì ì˜ìˆ˜ì¦ í‘œì‹œ
                        showElectronicReceipt(renterName, receiptItems, dateStr);
                    } else { showToast('ì‹¤íŒ¨: ' + result.message); }
                })
                .catch(function (e) {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-loading');
                    showToast('ì˜¤ë¥˜ ë°œìƒ');
                });
        }

        function showElectronicReceipt(renter, items, date) {
            document.getElementById('receipt-renter').textContent = renter;
            document.getElementById('receipt-date').textContent = date;

            var tbody = document.getElementById('receipt-items-body');
            tbody.innerHTML = '';

            // Grouping Logic
            var groupedItems = {};
            items.forEach(function (item) {
                if (!groupedItems[item.name]) {
                    groupedItems[item.name] = {
                        location: item.location || 'ë¯¸ì§€ì •',
                        variants: []
                    };
                }
                groupedItems[item.name].variants.push({
                    details: item.details,
                    quantity: item.quantity
                });
            });

            var totalQty = 0;
            for (var productName in groupedItems) {
                var group = groupedItems[productName];
                // Product Name Row (with Location)
                var nameTr = document.createElement('tr');
                nameTr.innerHTML = '<td colspan="2" class="product-group-header">' +
                    productName +
                    ' <span style="font-size: 12px; color: #888; font-weight: normal; margin-left:8px;">[' + group.location + ']</span>' +
                    '</td>';
                tbody.appendChild(nameTr);

                // Variant Rows
                group.variants.forEach(function (variant) {
                    var varTr = document.createElement('tr');
                    varTr.className = 'variant-row';
                    varTr.innerHTML = '<td>' + variant.details + '</td>' +
                        '<td class="qty-cell">' + variant.quantity + '</td>';
                    tbody.appendChild(varTr);
                    totalQty += variant.quantity;
                });
            }

            document.getElementById('receipt-total-qty').textContent = totalQty;

            // í™”ë©´ì—ëŠ” ì•ˆ ë³´ì´ê²Œ ì²˜ë¦¬í•˜ê³  ì¸ì‡„ë§Œ ì‹¤í–‰
            const receiptModal = document.getElementById('receipt-modal');
            receiptModal.style.position = 'fixed';
            receiptModal.style.left = '-9999px'; // í™”ë©´ ë°–ìœ¼ë¡œ ì´ë™
            receiptModal.classList.remove('hidden');

            setTimeout(function () {
                window.print();
                // ì¸ì‡„ í›„ ë‹¤ì‹œ ì›ë˜ ìë¦¬ë¡œ ëŒë ¤ë†“ê³  ìˆ¨ê¹€
                receiptModal.classList.add('hidden');
                receiptModal.style.position = '';
                receiptModal.style.left = '';
            }, 300);

            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closeReceiptModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        function closeReceiptModal() {
            document.getElementById('receipt-modal').classList.add('hidden');
        }

        function toggleCheckoutMode(mode) {
            var rentalBtn = document.getElementById('toggle-rental');
            var returnBtn = document.getElementById('toggle-return');
            var rentalDiv = document.getElementById('rental-checkout');
            var returnDiv = document.getElementById('return-checkout');
            if (mode === 'rental') {
                rentalBtn.classList.add('active'); returnBtn.classList.remove('active');
                rentalDiv.classList.remove('hidden'); returnDiv.classList.add('hidden');
            } else {
                returnBtn.classList.add('active'); rentalBtn.classList.remove('active');
                returnDiv.classList.remove('hidden'); rentalDiv.classList.add('hidden');
                document.getElementById('unified-search-input').value = '';
                document.getElementById('search-suggestions').classList.remove('visible');
                renderReturnList([]);
                document.getElementById('return-list').innerHTML = '<div class="loader">ê²€ìƒ‰í•˜ì„¸ìš”</div>';
            }
        }

        function handleSearchInputSuggestions(e) {
            var query = e.target.value.trim();
            var suggestionsBox = document.getElementById('search-suggestions');
            if (!query) { suggestionsBox.innerHTML = ''; suggestionsBox.classList.remove('visible'); return; }

            var brandMatches = (appData.brands || []).filter(function (brand) { return brand.includes(query) || getChosung(brand).includes(query); }).map(function (brand) { return { type: 'brand', text: brand }; });
            var uniqueRenters = [];
            appData.rentals.filter(function (item) { return item.status === 'ëŒ€ì—¬ì¤‘'; }).forEach(function (item) { if (item.renter && uniqueRenters.indexOf(item.renter) === -1) uniqueRenters.push(item.renter); });

            var renterMatches = uniqueRenters.filter(function (renter) { return renter.includes(query) || getChosung(renter).includes(query); }).map(function (renter) { return { type: 'renter', text: renter }; });
            var allMatches = brandMatches.concat(renterMatches);

            if (allMatches.length > 0) {
                suggestionsBox.innerHTML = '';
                var fragment = document.createDocumentFragment();
                allMatches.forEach(function (match) {
                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.innerHTML = '<span class="suggestion-text">' + match.text + '</span>';
                    itemDiv.onclick = function () {
                        document.getElementById('unified-search-input').value = match.text;
                        suggestionsBox.classList.remove('visible');
                    };
                    fragment.appendChild(itemDiv);
                });
                suggestionsBox.appendChild(fragment);
                suggestionsBox.classList.add('visible');
            } else { suggestionsBox.classList.remove('visible'); }
        }

        function executeSearch() {
            var query = document.getElementById('unified-search-input').value.trim();
            var listDiv = document.getElementById('return-list');
            if (!query) { showToast('ê²€ìƒ‰ì–´ ì…ë ¥'); listDiv.innerHTML = '<div class="loader">ê²€ìƒ‰ì–´ ì…ë ¥</div>'; return; }

            var items = appData.rentals.filter(function (item) {
                if (item.status !== 'ëŒ€ì—¬ì¤‘') return false;
                if (query === 'ì „ì²´') return true;
                return (item.renter.includes(query) || getChosung(item.renter).includes(query)) ||
                    (item.productName.includes(query) || getChosung(item.productName).includes(query));
            });
            renderReturnList(items);
        }

        function renderReturnList(items) {
            currentReturnItems = items.map(function (item) { item.checked = false; return item; });

            // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ ë° ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            var countSpan = document.getElementById('return-list-count');
            if (countSpan) countSpan.textContent = items.length ? '(' + items.length + ')' : '';
            var selectAllChk = document.getElementById('select-all-return-chk');
            if (selectAllChk) selectAllChk.checked = false;

            var div = document.getElementById('return-list');
            div.innerHTML = '';
            if (!items.length) { div.innerHTML = '<div class="loader">ê²°ê³¼ ì—†ìŒ</div>'; return; }

            var fragment = document.createDocumentFragment();
            items.forEach(function (item, index) {
                var itemDiv = document.createElement('div');
                itemDiv.className = 'return-item';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.onchange = function (e) { currentReturnItems[index].checked = e.target.checked; };

                var checkboxCol = document.createElement('div'); checkboxCol.className = 'col-chk'; checkboxCol.appendChild(checkbox);
                var renterCol = document.createElement('div'); renterCol.className = 'col-renter'; renterCol.textContent = item.renter;

                var mainCol = document.createElement('div'); mainCol.className = 'col-main';
                var titleDiv = document.createElement('div'); titleDiv.className = 'prod-title'; titleDiv.textContent = item.productName;
                var subDiv = document.createElement('div'); subDiv.className = 'prod-sub'; subDiv.textContent = item.size + ' / ' + item.color;
                mainCol.appendChild(titleDiv); mainCol.appendChild(subDiv);

                var qtyCol = document.createElement('div'); qtyCol.className = 'col-qty'; qtyCol.textContent = Math.abs(item.quantity);
                var dateCol = document.createElement('div'); dateCol.className = 'col-date'; dateCol.textContent = (item.rentalDate || '').split(' ')[0];

                itemDiv.appendChild(checkboxCol);
                itemDiv.appendChild(renterCol);
                itemDiv.appendChild(mainCol);
                itemDiv.appendChild(qtyCol);
                itemDiv.appendChild(dateCol);
                fragment.appendChild(itemDiv);
            });
            div.appendChild(fragment);
            showToast(items.length + 'ê±´ ê²€ìƒ‰');
        }

        function toggleAllReturnItems(checked) {
            currentReturnItems.forEach(function (item) { item.checked = checked; });
            var boxes = document.querySelectorAll('#return-list input[type="checkbox"]');
            for (var i = 0; i < boxes.length; i++) boxes[i].checked = checked;
        }

        function processReturnCheckout() {
            var returnerName = document.getElementById('returner-name').value.trim();
            if (!returnerName) { showToast('ì²˜ë¦¬ì ì´ë¦„ í•„ìš”'); return; }
            var checkedItems = currentReturnItems.filter(function (item) { return item.checked; });
            if (!checkedItems.length) { showToast('ìƒí’ˆ ì„ íƒ í•„ìš”'); return; }
            if (!confirm(returnerName + 'ë‹˜ ë°˜ë‚© ì§„í–‰?')) return;

            var btn = document.getElementById('process-return-btn');
            var originalText = btn.textContent;
            btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            btn.classList.add('btn-loading');

            callBackend('processReturn', checkedItems, returnerName)
                .then(function (result) {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-loading');
                    if (result.success) {
                        showToast(result.message || 'ë°˜ë‚© ì™„ë£Œ', true);

                        // --- ì‹¤ì‹œê°„ ì¬ê³  ê°€ì‚° ë™ê¸°í™” ---
                        checkedItems.forEach(function (item) {
                            var rawItem = appData.rawData.find(function (r) {
                                return r.productCode === item.productCode && r.color === item.color && r.size === item.size;
                            });
                            if (rawItem) {
                                rawItem.quantity += Math.abs(item.quantity);
                            } else {
                                // ê¸°ì¡´ì— ì¬ê³ ê°€ 0ì´ ë˜ì–´ ë¦¬ìŠ¤íŠ¸ì— ì—†ë˜ ê²½ìš° ìƒˆë¡œ ì¶”ê°€
                                appData.rawData.push({
                                    productCode: item.productCode,
                                    productName: item.productName,
                                    skuCode: item.skuCode,
                                    color: item.color,
                                    size: item.size,
                                    quantity: Math.abs(item.quantity),
                                    location: 'í™•ì¸í•„ìš”' // ë°˜ë‚© ì‹œ ìœ„ì¹˜ ì •ë³´ëŠ” ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œê°’
                                });
                            }
                        });

                        if (result.returnedItems) {
                            appData.rentals = appData.rentals.filter(function (item) { return result.returnedItems.indexOf(item.rowIndex) === -1; });
                        }
                        executeSearch();

                        // í˜„ì¬ ë³´ê³  ìˆëŠ” ìƒí’ˆì˜ ì¬ê³ í‘œ ì¦‰ì‹œ ê°±ì‹ 
                        if (currentProductCode) renderProductDetails(currentProductCode, document.getElementById('product-name').textContent);
                    } else { showToast('ë°˜ë‚© ì‹¤íŒ¨: ' + result.message); }
                })
                .catch(function (e) {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-loading');
                    showToast('ì—ëŸ¬ ë°œìƒ');
                });
        }

        function getChosung(str) {
            var CHO_HANGUL = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            var result = "";
            for (var i = 0; i < str.length; i++) {
                var code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    var choIdx = Math.floor(code / 588);
                    result += CHO_HANGUL[choIdx];
                } else {
                    result += str.charAt(i);
                }
            }
            return result;
        }

        function showToast(message, isSuccess) {
            var container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            var toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            container.appendChild(toast);

            if (isSuccess) {
                confetti();
            }

            setTimeout(function () { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
        }

        function confetti() {
            var d = 50;
            var colors = ['#ff7373', '#ffd473', '#73ff73', '#7373ff', '#ff73ff'];
            var center_x = window.innerWidth / 2;
            var center_y = window.innerHeight / 2;
            var radius = 200;

            var container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '2000';
            document.body.appendChild(container);

            for (var i = 0; i < d; i++) {
                var p = document.createElement('div');
                var color = colors[Math.floor(Math.random() * colors.length)];
                var size = Math.floor(Math.random() * 5) + 5;
                var angle = Math.random() * 360;
                var distance = Math.random() * radius;
                var rotation = Math.random() * 720;
                var duration = 1 + Math.random() * 2;

                var end_x = center_x + distance * Math.cos(angle * Math.PI / 180);
                var end_y = center_y + distance * Math.sin(angle * Math.PI / 180);

                p.style.cssText = 'position: absolute; width: ' + size + 'px; height: ' + size + 'px; background: ' + color + '; border-radius: 50%; top: ' + center_y + 'px; left: ' + center_x + 'px; opacity: 1; transition: transform ' + duration + 's ease-out, opacity ' + duration + 's ease-in;';

                container.appendChild(p);

                (function (p, end_x, end_y, rotation) {
                    setTimeout(function () {
                        p.style.transform = 'translate(' + (end_x - center_x) + 'px, ' + (end_y - center_y) + 'px) rotate(' + rotation + 'deg)';
                        p.style.opacity = '0';
                    }, 10);
                })(p, end_x, end_y, rotation);

                (function (p, duration) {
                    setTimeout(function () { if (p.parentNode) p.parentNode.removeChild(p); }, duration * 1000);
                })(p, duration);
            }
            setTimeout(function () { if (container.parentNode) container.parentNode.removeChild(container); }, 3500);
        }
    </script>
</body>

</html>